user www-data;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

# This number should be, at maximum, the number of CPU cores on your system.
worker_processes auto;

events {
    accept_mutex off;
}
http {
    access_log syslog:server=unix:/var/log/nginx.sock,nohostname;
    error_log syslog:server=unix:/var/log/nginx.sock,nohostname;
    sendfile on;
    sendfile_max_chunk 512k;

    # If the client stops reading data, free up the stale client connection after this much time.
    send_timeout 15;

    # Compression.
    gzip on;
    gzip_min_length 10240;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml;
    gzip_disable "msie6";
    upstream web {
        zone backend 64k;
        ip_hash; # 100% is working
        # server localhost:9088 backup;
        # server localhost:9089;
        # server localhost:9088;
        # server localhost:9087;
        server 192.167.1.2:9087 max_fails=1 fail_timeout=20s;
    }

    map $http_upgrade $proxy_connection {
        default upgrade;
        ''      close;
    }

    server {
        listen 192.167.1.10:80;
        proxy_next_upstream error timeout http_503;
        proxy_next_upstream_tries 2;
        aio threads;

        location / {
            proxy_pass http://web;
        }

        location /ws {
           proxy_pass http://web;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header Host $host;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

           # Pass the csrf token (see https://de.wikipedia.org/wiki/Cross-Site-Request-Forgery)
           # Default in Spring Boot
           proxy_pass_header X-XSRF-TOKEN;

           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection $proxy_connection;
           proxy_read_timeout 10000s;
        }
    }
}
